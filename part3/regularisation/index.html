<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
    <title>Unfolding & regularization - Combine</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    
    <link href="../../mystyle.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="../..">Combine</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Setting up the analysis <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../part2/settinguptheanalysis/">Preparing the datacard</a>
</li>

                        
                            
<li >
    <a href="../../part2/physicsmodels/">Physics models</a>
</li>

                        
                            
<li >
    <a href="../../part2/bin-wise-stats/">Automatic MC statistical uncertainties</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Running combine <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../runningthetool/">Running the tool</a>
</li>

                        
                            
<li >
    <a href="../commonstatsmethods/">Common statistical methods</a>
</li>

                        
                            
<li >
    <a href="../nonstandard/">Advanced use cases</a>
</li>

                        
                            
<li class="active">
    <a href="./">Unfolding & regularization</a>
</li>

                        
                            
<li >
    <a href="../validation/">Validating datacards</a>
</li>

                        
                            
<li >
    <a href="../debugging/">Debugging fit failures</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../part4/usefullinks/">Links & FAQ</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../part5/roofit/">RooFit Basics</a>
</li>

                        
                            
<li >
    <a href="../../part5/longexercise/">Exercise: main features</a>
</li>

                        
                            
<li >
    <a href="../../part5/longexerciseanswers/">Solutions to long exercise</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../nonstandard/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../validation/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/edit/102x/docs/part3/regularisation.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#unfolding-regularization">Unfolding &amp; regularization</a></li>
            <li class="second-level"><a href="#likelihood-based-unfolding">Likelihood-based unfolding</a></li>
                
            <li class="second-level"><a href="#regularization">Regularization</a></li>
                
                <li class="third-level"><a href="#singular-value-decomposition-svd">Singular Value Decomposition (SVD)</a></li>
                <li class="third-level"><a href="#tunfold-method">TUnfold method</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="unfolding-regularization">Unfolding &amp; regularization</h1>
<p>This section details how to perform an unfolded cross-section measurement, <em>including regularization</em>, inside Combine. </p>
<p>There are many resources available that describe unfolding, including when to use it (or not), and what are the usual issues around it. A useful summary is available at the <a href="https://twiki.cern.ch/twiki/bin/view/CMS/ScrecUnfolding">CMS Statistics Committee pages</a> on unfolding. You can also 
find a nice overview of unfolding and its usage in combine in <a href="https://indico.cern.ch/event/399923/contributions/956409/attachments/800899/1097609/2015_06_24_LHCXSWG.pdf#search=Marini%20AND%20StartDate%3E%3D2015-06-24%20AND%20EndDate%3C%3D2015-06-24">these slides</a>.</p>
<p>The basic idea behind the unfolding technique to describe smearing introduced through the reconstruction (eg of the particle energy) in a given truth level bin <span class="arithmatex"><span class="MathJax_Preview">x_{i}</span><script type="math/tex">x_{i}</script></span> through a linear relationship to the effects in the nearby truth-bins. We can make statements about the probability <span class="arithmatex"><span class="MathJax_Preview">p_{j}</span><script type="math/tex">p_{j}</script></span> that the event falling in the truth bin <span class="arithmatex"><span class="MathJax_Preview">x_{i}</span><script type="math/tex">x_{i}</script></span> is reconstructed in the bin <span class="arithmatex"><span class="MathJax_Preview">y_{i}</span><script type="math/tex">y_{i}</script></span> via the linear relationship,</p>
<div class="arithmatex">
<div class="MathJax_Preview">
y_{obs} = \tilde{\boldsymbol{R}}\cdot x_{true} + b
</div>
<script type="math/tex; mode=display">
y_{obs} = \tilde{\boldsymbol{R}}\cdot x_{true} + b
</script>
</div>
<p>or, if the truth bins are expressed relative to some particular model, we use the usual <em>signal strength</em> terminology, </p>
<div class="arithmatex">
<div class="MathJax_Preview">
y_{obs} = \boldsymbol{R}\cdot \mu + b
</div>
<script type="math/tex; mode=display">
y_{obs} = \boldsymbol{R}\cdot \mu + b
</script>
</div>
<p>Unfolding aims to find the distribution at truth level <span class="arithmatex"><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>, given the observations <span class="arithmatex"><span class="MathJax_Preview">y</span><script type="math/tex">y</script></span> at reco-level.</p>
<h2 id="likelihood-based-unfolding">Likelihood-based unfolding</h2>
<p>Since Combine has access to the full likelihood for any analysis written in the usual datacard format, we will use likelihood-based unfolding 
throughout - for other approaches, there are many other tools available (eg <code>RooUnfold</code> or <code>TUnfold</code>), which can be used instead. </p>
<p>The benefits of the likelihood-based approach are that, </p>
<ul>
<li>Background subtraction is accounted for directly in the likelihood</li>
<li>Systematic uncertainties are accounted for directly during the unfolding as nuisance parameters</li>
<li>We can profile the nuisance parameters during the unfolding to make the most of the data available </li>
</ul>
<p>In practice, one must construct the <em>response matrix</em> and unroll it in the reconstructed bins:</p>
<ul>
<li>First, one derives the truth  distribution, eg after the generator-cut only, <span class="arithmatex"><span class="MathJax_Preview">x_{i}</span><script type="math/tex">x_{i}</script></span>.</li>
<li>Each reconstructed bin (eg each datacard) should describe the contribution from each truth bin - this is how combine knows about <span class="arithmatex"><span class="MathJax_Preview">\boldsymbol{R}</span><script type="math/tex">\boldsymbol{R}</script></span> 
and folds in the acceptance/efficiency effects as usual.</li>
<li>The out-of-acceptance contributions can also be included in the above.</li>
</ul>
<p>The model we use for this is then just the usual <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/102x/python/PhysicsModel.py#L98"><code>PhysicsModel:multiSignalModel</code></a>, where each <em>signal</em> refers to a particular truth level bin. The results can be extracted through a 
simple maximum likelihood fit with, </p>
<pre><code>    text2workspace.py -m 125 --X-allow-no-background -o datacard.root datacard.txt
       -P HiggsAnalysis.CombinedLimit.PhysicsModel:multiSignalModel --PO map='.*GenBin0.*:r_Bin0[1,-1,20]' --PO map='.*GenBin1.*:r_Bin1[1,-1,20]' --PO map='.*GenBin2.*:r_Bin2[1,-1,20]' --PO map='.*GenBin3.*:r_Bin3[1,-1,20]' --PO map='.*GenBin4.*:r_Bin4[1,-1,20]'

    combine -M MultiDimFit --setParameters=r_Bin0=1,r_Bin1=1,r_Bin2=1,r_Bin3=1,r_Bin4=1 -t -1 -m 125 datacard.root
    combine -M MultiDimFit --setParameters=r_Bin0=1,r_Bin1=1,r_Bin2=1,r_Bin3=1,r_Bin4=1 -t -1 -m 125 --algo=grid --points=100 -P r_Bin1 --setParameterRanges r_Bin1=0.5,1.5 --floatOtherPOIs=1 datacard.root
</code></pre>
<p>Notice that one can also perform the so called bin-by-bin unfolding (though it is strongly discouraged except for testing) with, </p>
<pre><code>    text2workspace.py -m 125 --X-allow-no-background -o datacard.root datacard.txt
      -P HiggsAnalysis.CombinedLimit.PhysicsModel:multiSignalModel --PO map='.*RecoBin0.*:r_Bin0[1,-1,20]' --PO map='.*RecoBin1.*:r_Bin1[1,-1,20]' --PO map='.*RecoBin2.*:r_Bin2[1,-1,20]' --PO map='.*RecoBin3.*:r_Bin3[1,-1,20]' --PO map='.*RecoBin4.*:r_Bin4[1,-1,20]'
</code></pre>
<p>Nuisance parameters can be added to the likelihood function and profiled in the usual way via the datacards. Theory uncertainties on the inclusive cross section are typically not included in unfolded measurements.</p>
<h2 id="regularization">Regularization</h2>
<p>The main difference with respect to other models with multiple signal contributions is the introduction of <strong>Regularization</strong>, which is used to stabilize the unfolding process. </p>
<p>An example of unfolding in combine with and without regularization,  can be found under 
<a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/tree/102x/data/tutorials/regularization">data/tutorials/regularization</a>. </p>
<p>Running <code>python createWs.py [-r]</code> will create a simple datacard and perform a fit both with and without including regularization.</p>
<p>The simplest way to introduce regularization in the likelihood based approach, is to apply a penalty term in the likelihood function which 
depends on the values of the truth bins (so called <em>Tickonov regularization</em>):</p>
<div class="arithmatex">
<div class="MathJax_Preview">
-2\ln L = -2\ln L + P(\vec{x}) 
</div>
<script type="math/tex; mode=display">
-2\ln L = -2\ln L + P(\vec{x}) 
</script>
</div>
<p>where <span class="arithmatex"><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> is a linear operator. There are two different approches which are supported to construct <span class="arithmatex"><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span>.
If instead you run <code>python makeModel.py</code>, you will create a more complex datacard with each the two regularization scheme implemented. You will need 
to uncomment the relevant sections of code to activate SVD or TUnfold type regularization.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Any unfolding method which makes use of regularization must perform studies of the potential bias/coverage properties introduced through the </p>
</div>
<p>inclusion of regularization, and how strong the associated regularization is. Advice on this can be found in the CMS Statistics Committee pages. </p>
<h3 id="singular-value-decomposition-svd">Singular Value Decomposition (SVD)</h3>
<p>In the SVD approach - as described in the SVD paper - the penalty term is constructed directly based on the strengths (<span class="arithmatex"><span class="MathJax_Preview">\vec{\mu}=\{\mu_{i}\}_{i=1}^{N}</span><script type="math/tex">\vec{\mu}=\{\mu_{i}\}_{i=1}^{N}</script></span>), </p>
<div class="arithmatex">
<div class="MathJax_Preview">
P = \tau\left| A\cdot \vec{\mu} \right|^{2},
</div>
<script type="math/tex; mode=display">
P = \tau\left| A\cdot \vec{\mu} \right|^{2},
</script>
</div>
<p>where <span class="arithmatex"><span class="MathJax_Preview">A</span><script type="math/tex">A</script></span> is typically the discrete curvature matrix, with </p>
<div class="arithmatex">
<div class="MathJax_Preview">
A = 
\begin{bmatrix} 
1 &amp; -1 &amp; ... \\
1 &amp; -2 &amp; 1 &amp;  ... \\
... 
\end{bmatrix}
</div>
<script type="math/tex; mode=display">
A = 
\begin{bmatrix} 
1 & -1 & ... \\
1 & -2 & 1 &  ... \\
... 
\end{bmatrix}
</script>
</div>
<p>Penalty terms on the derivatives can also be included. Such a penalty term is included by modifying the likelihood to include one constraint for each 
row of the product <span class="arithmatex"><span class="MathJax_Preview">A\cdot\vec{\mu}</span><script type="math/tex">A\cdot\vec{\mu}</script></span>, by including them as lines in the datacard of the form, </p>
<pre><code>    name constr formula dependents delta
</code></pre>
<p>where the regularization strength <span class="arithmatex"><span class="MathJax_Preview">\delta=\frac{1}{\sqrt{\tau}}</span><script type="math/tex">\delta=\frac{1}{\sqrt{\tau}}</script></span> and can either be a fixed value (eg by putting directly <code>0.01</code>) or as 
a modifiable parameter with eg <code>delta[0.01]</code>. </p>
<p>For example, for 3 bins and a regularization strength of 0.03, the first line would be </p>
<pre><code>    name constr @0-2*@2+@1 r_Bin0,r_Bin1,r_Bin2 0.03
</code></pre>
<p>Alternative, valid syntaxes are  </p>
<pre><code>    constr1 constr r_bin0-r_bin1 0.01
    constr1 constr r_bin0-r_bin1 delta[0.01]
    constr1 constr r_bin0+r_bin1 r_bin0,r_bin1 0.01
    constr1 constr r_bin0+r_bin1 {r_bin0,r_bin1} delta[0.01]
</code></pre>
<h3 id="tunfold-method">TUnfold method</h3>
<p>The Tikhonov regularization as implemented in TUnfold uses the MC information, or rather the densities prediction, as a bias vector. 
In order to give this information to Combine, a single datacard for each reco-level bin needs to be produced, so that we have access to the proper normalization terms during the minimization. In this case the bias vector is <span class="arithmatex"><span class="MathJax_Preview">\vec{x}_{obs}-\vec{x}_{true}</span><script type="math/tex">\vec{x}_{obs}-\vec{x}_{true}</script></span> </p>
<p>Then one can write a constraint term in the datacard via (eg.)</p>
<pre><code>    constr1 constr (r_Bin0-1.)*(shapeSig_GenBin0_RecoBin0__norm+shapeSig_GenBin0_RecoBin1__norm+shapeSig_GenBin0_RecoBin2__norm+shapeSig_GenBin0_RecoBin3__norm+shapeSig_GenBin0_RecoBin4__norm)+(r_Bin2-1.)*(shapeSig_GenBin2_RecoBin0__norm+shapeSig_GenBin2_RecoBin1__norm+shapeSig_GenBin2_RecoBin2__norm+shapeSig_GenBin2_RecoBin3__norm+shapeSig_GenBin2_RecoBin4__norm)-2*(r_Bin1-1.)*(shapeSig_GenBin1_RecoBin0__norm+shapeSig_GenBin1_RecoBin1__norm+shapeSig_GenBin1_RecoBin2__norm+shapeSig_GenBin1_RecoBin3__norm+shapeSig_GenBin1_RecoBin4__norm) {r_Bin0,r_Bin1,r_Bin2,shapeSig_GenBin1_RecoBin0__norm,shapeSig_GenBin0_RecoBin0__norm,shapeSig_GenBin2_RecoBin0__norm,shapeSig_GenBin1_RecoBin1__norm,shapeSig_GenBin0_RecoBin1__norm,shapeSig_GenBin2_RecoBin1__norm,shapeSig_GenBin1_RecoBin2__norm,shapeSig_GenBin0_RecoBin2__norm,shapeSig_GenBin2_RecoBin2__norm,shapeSig_GenBin1_RecoBin3__norm,shapeSig_GenBin0_RecoBin3__norm,shapeSig_GenBin2_RecoBin3__norm,shapeSig_GenBin1_RecoBin4__norm,shapeSig_GenBin0_RecoBin4__norm,shapeSig_GenBin2_RecoBin4__norm} delta[0.03]
</code></pre></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
