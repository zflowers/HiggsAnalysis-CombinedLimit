<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">

    
    <title>RooFit Basics - Combine</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    
    <link href="../../mystyle.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="../..">Combine</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Setting up the analysis <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../part2/settinguptheanalysis/">Preparing the datacard</a>
</li>

                        
                            
<li >
    <a href="../../part2/physicsmodels/">Physics models</a>
</li>

                        
                            
<li >
    <a href="../../part2/bin-wise-stats/">Automatic MC statistical uncertainties</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Running combine <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../part3/runningthetool/">Running the tool</a>
</li>

                        
                            
<li >
    <a href="../../part3/commonstatsmethods/">Common statistical methods</a>
</li>

                        
                            
<li >
    <a href="../../part3/nonstandard/">Advanced use cases</a>
</li>

                        
                            
<li >
    <a href="../../part3/regularisation/">Unfolding & regularization</a>
</li>

                        
                            
<li >
    <a href="../../part3/validation/">Validating datacards</a>
</li>

                        
                            
<li >
    <a href="../../part3/debugging/">Debugging fit failures</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../part4/usefullinks/">Links & FAQ</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li class="active">
    <a href="./">RooFit Basics</a>
</li>

                        
                            
<li >
    <a href="../longexercise/">Exercise: main features</a>
</li>

                        
                            
<li >
    <a href="../longexerciseanswers/">Solutions to long exercise</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../part4/usefullinks/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../longexercise/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/edit/102x/docs/part5/roofit.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#roofit">RooFit</a></li>
            <li class="second-level"><a href="#objects">Objects</a></li>
                
            <li class="second-level"><a href="#datasets">Datasets</a></li>
                
        <li class="first-level "><a href="#likelihoods-and-fitting-to-data">Likelihoods and Fitting to data</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="roofit">RooFit</h1>
<p><code>RooFit</code> is a OO analysis environment built on <code>ROOT</code>. It has a collection of classes designed to augment root for data modeling.</p>
<p>This section covers a few of the basics of <code>RooFit</code>. There are many more tutorials available at this link: <a href="https://root.cern.ch/root/html600/tutorials/roofit/index.html">https://root.cern.ch/root/html600/tutorials/roofit/index.html</a></p>
<h2 id="objects">Objects</h2>
<p>In Roofit, any variable, data point, function, PDF (etc.) is represented by a c++ object
The most basic of these is the <code>RooRealVar</code>. Let's create one which will represent the mass of some hypothetical particle, we name it and give it an initial starting value and range.</p>
<pre><code class="language-c++">RooRealVar MH(&quot;MH&quot;,&quot;mass of the Hypothetical Boson (H-boson) in GeV&quot;,125,120,130);
MH.Print();
</code></pre>
<pre><code class="language-shell">RooRealVar::MH = 125  L(120 - 130)
</code></pre>
<p>ok, great. This variable is now an object we can play around with. We can access this object and modify it's properties, such as its value. </p>
<pre><code class="language-c++">MH.setVal(130);
MH.getVal();
</code></pre>
<p>In particle detectors we typically don't observe this particle mass but usually define some observable which is <em>sensitive</em> to this mass. Lets assume we can detect and reconstruct the decay products of the H-boson and measure the invariant mass of those particles. We need to make another variable which represents that invariant mass.</p>
<pre><code class="language-c++">RooRealVar mass(&quot;m&quot;,&quot;m (GeV)&quot;,100,80,200);
</code></pre>
<p>In the perfect world we would perfectly measure the exact mass of the particle in every single event. However, our detectors are usually far from perfect so there will be some resolution effect. Lets assume the resolution of our measurement of the invariant mass is 10 GeV and call it "sigma"</p>
<pre><code class="language-c++">RooRealVar sigma(&quot;resolution&quot;,&quot;#sigma&quot;,10,0,20);
</code></pre>
<p>More exotic variables can be constructed out of these <code>RooRealVar</code>s using <code>RooFormulaVars</code>. For example, suppose we wanted to make a function out of the variables which represented the relative resolution as a function of the hypothetical mass MH. </p>
<pre><code class="language-c++">RooFormulaVar func(&quot;R&quot;,&quot;@0/@1&quot;,RooArgList(sigma,mass));
func.Print(&quot;v&quot;);
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell">--- RooAbsArg ---
  Value State: DIRTY
  Shape State: DIRTY
  Attributes: 
  Address: 0x10e878068
  Clients: 
  Servers: 
    (0x10dcd47b0,V-) RooRealVar::resolution &quot;#sigma&quot;
    (0x10dcd4278,V-) RooRealVar::m &quot;m (GeV)&quot;
  Proxies: 
    actualVars -&gt; 
      1)  resolution
      2)           m
--- RooAbsReal ---

  Plot label is &quot;R&quot;
    --- RooFormula ---
    Formula: &quot;@0/@1&quot;
    (resolution,m)
</code></pre>

</details>

<p>Notice how there is a list of the variables we passed (the servers or "actual vars"). We can now plot the function. RooFit has a special plotting object <code>RooPlot</code> which keeps track of the objects (and their normalisations) which we want to draw. Since RooFit doesn't know the difference between which objects are/aren't dependant, we need to tell it. </p>
<p>Right now, we have the relative resolution as <span class="arithmatex"><span class="MathJax_Preview">R(m,\sigma)</span><script type="math/tex">R(m,\sigma)</script></span>, whereas we want to plot 
<span class="arithmatex"><span class="MathJax_Preview">R(m,\sigma(m))</span><script type="math/tex">R(m,\sigma(m))</script></span>!</p>
<pre><code class="language-c++">TCanvas *can = new TCanvas();

//make the x-axis the &quot;mass&quot;
RooPlot *plot = mass.frame(); 
func.plotOn(plot);

plot-&gt;Draw();
can-&gt;Draw();
</code></pre>
<p><img alt="" src="../images/expo.png" /></p>
<p>The main objects we are interested in using from RooFit are <em>probability denisty functions</em> or (PDFs). We can construct the PDF,</p>
<div class="arithmatex">
<div class="MathJax_Preview">
f(m|M_{H},\sigma)
</div>
<script type="math/tex; mode=display">
f(m|M_{H},\sigma)
</script>
</div>
<p>as a simple Gaussian shape for example or a <code>RooGaussian</code> in RooFit language (think McDonald's logic, everything is a <code>RooSomethingOrOther</code>)</p>
<pre><code class="language-c++">RooGaussian gauss(&quot;gauss&quot;,&quot;f(m|M_{H},#sigma)&quot;,mass,MH,sigma);
gauss.Print(&quot;V&quot;);
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell">--- RooAbsArg ---
  Value State: DIRTY
  Shape State: DIRTY
  Attributes: 
  Address: 0x10ecf4188
  Clients: 
  Servers: 
    (0x10dcd4278,V-) RooRealVar::m &quot;m (GeV)&quot;
    (0x10a08a9d8,V-) RooRealVar::MH &quot;mass of the Hypothetical Boson (H-boson) in GeV&quot;
    (0x10dcd47b0,V-) RooRealVar::resolution &quot;#sigma&quot;
  Proxies: 
    x -&gt; m
    mean -&gt; MH
    sigma -&gt; resolution
--- RooAbsReal ---

  Plot label is &quot;gauss&quot;
--- RooAbsPdf ---
Cached value = 0
</code></pre>

</details>

<p>Notice how the gaussian PDF, like the <code>RooFormulaVar</code> depends on our <code>RooRealVar</code> objects, these are its servers.  Its evaluation will depend on their values. </p>
<p>The main difference between PDFs and Functions in RooFit is that PDFs are <em>automatically normalised to unitiy</em>, hence they represent a probability density, you don't need to normalise yourself. Lets plot it for the different values of <span class="arithmatex"><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.</p>
<pre><code class="language-c++">plot = mass.frame();

gauss.plotOn(plot);

MH.setVal(120);
gauss.plotOn(plot,RooFit::LineColor(kBlue));

MH.setVal(125);
gauss.plotOn(plot,RooFit::LineColor(kRed));

MH.setVal(135);
gauss.plotOn(plot,RooFit::LineColor(kGreen));

plot-&gt;Draw();

can-&gt;Update();
can-&gt;Draw();
</code></pre>
<p><img alt="" src="../images/gaus.png" /></p>
<p>Note that as we change the value of <code>MH</code>, the PDF gets updated at the same time.</p>
<p>PDFs can be used to generate Monte Carlo data. One of the benefits of RooFit is that to do so only uses a single line of code! As before, we have to tell <code>RooFit</code> which variables to generate in (e.g which are the observables for an experiment). In this case, each of our events will be a single value of "mass" <span class="arithmatex"><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>. The arguments for the function are the set of observables, follwed by the number of events,</p>
<pre><code class="language-c++">RooDataSet *data = (RooDataSet*) gauss.generate(RooArgSet(mass),500); 
</code></pre>
<p>Now we can plot the data as with other RooFit objects.</p>
<pre><code class="language-c++">plot = mass.frame();

data-&gt;plotOn(plot);
gauss.plotOn(plot);
gauss.paramOn(plot);

plot-&gt;Draw();
can-&gt;Update();
can-&gt;Draw();
</code></pre>
<p><img alt="" src="../images/gausdata.png" /></p>
<p>Of course we're not in the business of generating MC events, but collecting <em>real data!</em>. Next we will look at using real data in <code>RooFit</code>.</p>
<h2 id="datasets">Datasets</h2>
<p>A dataset is essentially just a collection of points in N-dimensional (N-observables) space. There are two basic implementations in RooFit, </p>
<p>1) an "unbinned" dataset - <code>RooDataSet</code></p>
<p>2) a "binned" dataset - <code>RooDataHist</code></p>
<p>both of these use the same basic structure as below</p>
<p><img alt="" src="../images/datastructure.png" /></p>
<p>Lets create an empty dataset where the only observable, the mass. Points can be added to the dataset one by one ...</p>
<pre><code class="language-c++">RooDataSet mydata(&quot;dummy&quot;,&quot;My dummy dataset&quot;,RooArgSet(mass)); 
// We've made a dataset with one observable (mass)

mass.setVal(123.4);
mydata.add(RooArgSet(mass));
mass.setVal(145.2);
mydata.add(RooArgSet(mass));
mass.setVal(170.8);
mydata.add(RooArgSet(mass));

mydata.Print();
</code></pre>
<pre><code class="language-shell">RooDataSet::dummy[m] = 3 entries
</code></pre>
<p>There are also other ways to manipulate datasets in this way as shown in the diagram below </p>
<p><img alt="" src="../images/datasets_manip.png" /></p>
<p>Luckily there are also Constructors for a <code>RooDataSet</code> from a <code>TTree</code> and for a <code>RooDataHist</code> from a <code>TH1</code> so its simple to convert from your usual ROOT objects.</p>
<p>Let's take an example dataset put together already.</p>
<pre><code class="language-c++">TFile *file = TFile::Open(&quot;tutorial.root&quot;);
file-&gt;ls();
</code></pre>
<details>
<summary><b>Show file contents</b></summary>

<pre><code class="language-shell">TFile**     tutorial.root
 TFile*     tutorial.root
  KEY: RooWorkspace workspace;1 Tutorial Workspace
  KEY: TProcessID   ProcessID0;1    48737500-e7e5-11e6-be6f-0d0011acbeef
</code></pre>

</details>

<p>Inside the file, there is something called a <code>RooWorkspace</code>. This is just the RooFit way of keeping a persistent link between the objects for a model. It is a very useful way to share data and PDFs/functions etc among CMS collaborators.</p>
<p>Let's take a look at it. It contains a <code>RooDataSet</code> and one variable. This time we called our variable (or observable) <code>CMS_hgg_mass</code>, let's assume now that this is the invariant mass of photon pairs where we assume our H-boson decays to photons.  </p>
<pre><code class="language-c++">RooWorkspace *wspace = (RooWorkspace*) file-&gt;Get(&quot;workspace&quot;);
wspace-&gt;Print(&quot;v&quot;);
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell">RooWorkspace(workspace) Tutorial Workspace contents

variables
---------
(CMS_hgg_mass)

datasets
--------
RooDataSet::dataset(CMS_hgg_mass)
</code></pre>

</details>

<p>Let's have a look at the data. The <code>RooWorkspace</code> has several accessor functions, we will use the <code>RooWorkspace::data</code> one. 
There are also <code>RooWorkspace::var</code>, <code>RooWorkspace::function</code> and <code>RooWorkspace::pdf</code> with (hopefully) obvious purposes.</p>
<pre><code class="language-c++">RooDataSet *hgg_data = (RooDataSereat*) wspace-&gt;data(&quot;dataset&quot;);
RooRealVar *hgg_mass = (RooRealVar*) wspace-&gt;var(&quot;CMS_hgg_mass&quot;);

plot = hgg_mass-&gt;frame();

hgg_data-&gt;plotOn(plot,RooFit::Binning(160)); 
// Here we've picked a certain number of bins just for plotting purposes 

plot-&gt;Draw();
can-&gt;Update();
can-&gt;Draw();
</code></pre>
<p><a href="../images/realdata.png"></a></p>
<h1 id="likelihoods-and-fitting-to-data">Likelihoods and Fitting to data</h1>
<p>The data we have in our file doesn't look like a Gaussian distribution. Instead, we could probably use something like an exponential to describe it. </p>
<p>There is an exponential PDF already in <code>RooFit</code> (yep you guessed it) <code>RooExponential</code>. For a pdf, we only need one parameter which is the exponential slope <span class="arithmatex"><span class="MathJax_Preview">\alpha</span><script type="math/tex">\alpha</script></span> so our pdf is,  </p>
<div class="arithmatex">
<div class="MathJax_Preview"> f(m|\alpha) = \dfrac{1}{N} e^{-\alpha m}</div>
<script type="math/tex; mode=display"> f(m|\alpha) = \dfrac{1}{N} e^{-\alpha m}</script>
</div>
<p>Where of course, <span class="arithmatex"><span class="MathJax_Preview">N = \int_{110}^{150} e^{-\alpha m} dm</span><script type="math/tex">N = \int_{110}^{150} e^{-\alpha m} dm</script></span> is the normalisation constant.</p>
<p>You can fund a bunch of available RooFit functions here: <a href="https://root.cern.ch/root/html/ROOFIT_ROOFIT_Index.html">https://root.cern.ch/root/html/ROOFIT_ROOFIT_Index.html</a></p>
<p>There is also support for a generic pdf in the form of a <code>RooGenericPdf</code>, check this link: <a href="https://root.cern.ch/doc/v608/classRooGenericPdf.html">https://root.cern.ch/doc/v608/classRooGenericPdf.html</a></p>
<p>Let's create an exponential PDF for our background, </p>
<pre><code class="language-c++">RooRealVar alpha(&quot;alpha&quot;,&quot;#alpha&quot;,-0.05,-0.2,0.01);
RooExponential expo(&quot;exp&quot;,&quot;exponential function&quot;,*hgg_mass,alpha);
</code></pre>
<p>We can use RooFit to tell us to estimate the value of <span class="arithmatex"><span class="MathJax_Preview">\alpha</span><script type="math/tex">\alpha</script></span> using this dataset. You will learn more about parameter estimation but for now we will just assume you know about maximising likelihoods. This <em>maximum likelihood estimator</em> is common in HEP and is known to give unbiased estimates for things like distribution means etc. </p>
<p>This also introduces the other main use of PDFs in RooFit. They can be used to construct <em>likelihoods</em> easily.</p>
<p>The likelihood <span class="arithmatex"><span class="MathJax_Preview">\mathcal{L}</span><script type="math/tex">\mathcal{L}</script></span> is defined for a particluar dataset (and model) as being proportional to the probability to observe the data assuming some pdf. For our data, the probability to observe an event with a value in an interval bounded by a and b is given by,</p>
<div class="arithmatex">
<div class="MathJax_Preview"> P\left(m~\epsilon~[a,b] \right) = \int_{a}^{b} f(m|\alpha)dm  </div>
<script type="math/tex; mode=display"> P\left(m~\epsilon~[a,b] \right) = \int_{a}^{b} f(m|\alpha)dm  </script>
</div>
<p>As that interval shrinks we can say this probability just becomes equal to <span class="arithmatex"><span class="MathJax_Preview">f(m|\alpha)dm</span><script type="math/tex">f(m|\alpha)dm</script></span>.</p>
<p>The probability to observe the dataset we have is given by the product of such probabilities for each of our data points, so that </p>
<div class="arithmatex">
<div class="MathJax_Preview">\mathcal{L}(\alpha) \propto \prod_{i} f(m_{i}|\alpha)</div>
<script type="math/tex; mode=display">\mathcal{L}(\alpha) \propto \prod_{i} f(m_{i}|\alpha)</script>
</div>
<p>Note that for a specific dataset, the <span class="arithmatex"><span class="MathJax_Preview">dm</span><script type="math/tex">dm</script></span> factors which should be there are constnant. They can therefore be absorbed into the constant of proportionality!</p>
<p>The maximum likelihood esitmator for <span class="arithmatex"><span class="MathJax_Preview">\alpha</span><script type="math/tex">\alpha</script></span>, usually written as <span class="arithmatex"><span class="MathJax_Preview">\hat{\alpha}</span><script type="math/tex">\hat{\alpha}</script></span>, is found by maximising <span class="arithmatex"><span class="MathJax_Preview">\mathcal{L}(\alpha)</span><script type="math/tex">\mathcal{L}(\alpha)</script></span>.</p>
<p>Note that this won't depend on the value of the constant of proportionality so we can ignore it. This is true in most scenarios because usually only the <em>ratio</em> of likelihoods is needed, in which the constant factors out. </p>
<p>Obviously this multiplication of exponentials can lead to very large (or very small) numbers which can lead to numerical instabilities. To avoid this, we can take logs of the likelihood. Its also common to multiply this by -1 and minimize the resulting <strong>N</strong>egative <strong>L</strong>og <strong>L</strong>ikelihood : <span class="arithmatex"><span class="MathJax_Preview">\mathrm{-Log}\mathcal{L}(\alpha)</span><script type="math/tex">\mathrm{-Log}\mathcal{L}(\alpha)</script></span>.</p>
<p><code>RooFit</code> can construct the <strong>NLL</strong> for us.</p>
<pre><code class="language-c++">RooNLLVar *nll = (RooNLLVar*) expo.createNLL(*hgg_data);
nll-&gt;Print(&quot;v&quot;);
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell">--- RooAbsArg ---
  Value State: DIRTY
  Shape State: DIRTY
  Attributes:
  Address: 0x7fdddbe46200
  Clients:
  Servers:
    (0x11eab5638,V-) RooRealVar::alpha &quot;#alpha&quot;
  Proxies:
    paramSet -&gt;
      1)  alpha
--- RooAbsReal ---

  Plot label is &quot;nll_exp_dataset&quot;
</code></pre>

</details>

<p>Notice that the NLL object knows which RooRealVar is the parameter because it doesn't find that one in the dataset. This is how RooFit distiguishes between <em>observables</em> and <em>parameters</em>.</p>
<p>RooFit has an interface to Minuit via the <code>RooMinimizer</code> class which takes the NLL as an argument. To minimize, we just call the <code>RooMinimizer::minimize()</code> function. <strong><code>Minuit2</code></strong> is the program and <strong><code>migrad</code></strong> is the minimization routine which uses gradient descent.</p>
<pre><code class="language-c++">RooMinimizer minim(*nll);
minim.minimize(&quot;Minuit2&quot;,&quot;migrad&quot;);  
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell"> **********
 **    1 **SET PRINT           1
 **********
 **********
 **    2 **SET NOGRAD
 **********
 PARAMETER DEFINITIONS:
    NO.   NAME         VALUE      STEP SIZE      LIMITS
     1 alpha       -5.00000e-02  2.10000e-02   -2.00000e-01  1.00000e-02
 **********
 **    3 **SET ERR         0.5
 **********
 **********
 **    4 **SET PRINT           1
 **********
 **********
 **    5 **SET STR           1
 **********
 NOW USING STRATEGY  1: TRY TO BALANCE SPEED AGAINST RELIABILITY
 **********
 **    6 **MIGRAD         500           1
 **********
 FIRST CALL TO USER FUNCTION AT NEW START POINT, WITH IFLAG=4.
 START MIGRAD MINIMIZATION.  STRATEGY  1.  CONVERGENCE WHEN EDM .LT. 1.00e-03
 FCN=3589.52 FROM MIGRAD    STATUS=INITIATE        4 CALLS           5 TOTAL
                     EDM= unknown      STRATEGY= 1      NO ERROR MATRIX
  EXT PARAMETER               CURRENT GUESS       STEP         FIRST
  NO.   NAME      VALUE            ERROR          SIZE      DERIVATIVE
   1  alpha       -5.00000e-02   2.10000e-02   2.24553e-01  -9.91191e+01
                               ERR DEF= 0.5
 MIGRAD MINIMIZATION HAS CONVERGED.
 MIGRAD WILL VERIFY CONVERGENCE AND ERROR MATRIX.
 COVARIANCE MATRIX CALCULATED SUCCESSFULLY
 FCN=3584.68 FROM MIGRAD    STATUS=CONVERGED      18 CALLS          19 TOTAL
                     EDM=1.4449e-08    STRATEGY= 1      ERROR MATRIX ACCURATE
  EXT PARAMETER                                   STEP         FIRST
  NO.   NAME      VALUE            ERROR          SIZE      DERIVATIVE
   1  alpha       -4.08262e-02   2.91959e-03   1.33905e-03  -3.70254e-03
                               ERR DEF= 0.5
 EXTERNAL ERROR MATRIX.    NDIM=  25    NPAR=  1    ERR DEF=0.5
  8.527e-06
</code></pre>

</details>

<p><code>RooFit</code> has found the best fit value of alpha for this dataset. It also estimates an uncertainty on alpha using the Hessian matrix from the fit.</p>
<pre><code class="language-c++">alpha.Print(&quot;v&quot;);
</code></pre>
<pre><code class="language-shell">--- RooAbsArg ---
  Value State: clean
  Shape State: clean
  Attributes:
  Address: 0x11eab5638
  Clients:
    (0x11eab5978,V-) RooExponential::exp &quot;exponential function&quot;
    (0x7fdddbe46200,V-) RooNLLVar::nll_exp_dataset &quot;-log(likelihood)&quot;
    (0x7fdddbe95600,V-) RooExponential::exp &quot;exponential function&quot;
    (0x7fdddbe5a400,V-) RooRealIntegral::exp_Int[CMS_hgg_mass] &quot;Integral of exponential function&quot;
  Servers:
  Proxies:
--- RooAbsReal ---

  Plot label is &quot;alpha&quot;
--- RooAbsRealLValue ---
  Fit range is [ -0.2 , 0.01 ]
--- RooRealVar ---
  Error = 0.00291959
</code></pre>
<p>Lets plot the resulting exponential on the data. Notice that the value of <span class="arithmatex"><span class="MathJax_Preview">\hat{\alpha}</span><script type="math/tex">\hat{\alpha}</script></span> is used for the exponential. </p>
<pre><code class="language-c++">expo.plotOn(plot);
expo.paramOn(plot);
plot-&gt;Draw();
can-&gt;Update();
can-&gt;Draw();
</code></pre>
<p><img alt="" src="../images/expofit.png" /></p>
<p>It looks like there could be a small region near 125 GeV for which our fit doesn't quite go through the points. Maybe our hypothetical H-boson isn't so hypothetical after all!</p>
<p>Let's see what happens if we include some resonant signal into the fit. We can take our Gaussian function again and use that as a signal model. A reasonable value for the resolution of a resonant signal with a mass around 125 GeV decaying to a pair of photons is around a GeV.</p>
<pre><code class="language-c++">sigma.setVal(1.);
sigma.setConstant();

MH.setVal(125);
MH.setConstant();

RooGaussian hgg_signal(&quot;signal&quot;,&quot;Gaussian PDF&quot;,*hgg_mass,MH,sigma);
</code></pre>
<p>By setting these parameters constant, RooFit knows (either when creating the NLL by hand or when using <code>fitTo</code>) that there is not need to fit for these parameters. </p>
<p>We need to add this to our exponential model and fit a "Sigmal+Background model" by creating a <code>RooAddPdf</code>. In RooFit there are two ways to add PDFs, recursively where the fraction of yields for the signal and background is a parameter or absolutely where each PDF has its own normalisation. We're going to use the second one.</p>
<pre><code class="language-c++">RooRealVar norm_s(&quot;norm_s&quot;,&quot;N_{s}&quot;,10,100);
RooRealVar norm_b(&quot;norm_b&quot;,&quot;N_{b}&quot;,0,1000);

const RooArgList components(hgg_signal,expo);
const RooArgList coeffs(norm_s,norm_b);

RooAddPdf model(&quot;model&quot;,&quot;f_{s+b}&quot;,components,coeffs);
model.Print(&quot;v&quot;);
</code></pre>
<details>
<summary><b>Show</b></summary>

<pre><code class="language-shell">--- RooAbsArg ---
  Value State: DIRTY
  Shape State: DIRTY
  Attributes: 
  Address: 0x11ed5d7a8
  Clients: 
  Servers: 
    (0x11ed5a0f0,V-) RooGaussian::signal &quot;Gaussian PDF&quot;
    (0x11ed5d058,V-) RooRealVar::norm_s &quot;N_{s}&quot;
    (0x11eab5978,V-) RooExponential::exp &quot;exponential function&quot;
    (0x11ed5d398,V-) RooRealVar::norm_b &quot;N_{b}&quot;
  Proxies: 
    !refCoefNorm -&gt; 
    !pdfs -&gt; 
      1)  signal
      2)     exp
    !coefficients -&gt; 
      1)  norm_s
      2)  norm_b
--- RooAbsReal ---

  Plot label is &quot;model&quot;
--- RooAbsPdf ---
Cached value = 0
</code></pre>

</details>

<p>Ok now lets fit the model. Note this time we add the option <code>Extended()</code> which tells RooFit that we care about the overall number of observed events in the data <span class="arithmatex"><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> too. It will add an additional Poisson term in the likelihood to account for this so our likelihood this time looks like,</p>
<div class="arithmatex">
<div class="MathJax_Preview">L_{s+b}(N_{s},N_{b},\alpha) = \dfrac{ N_{s}+N_{b}^{n} e^{N_{s}+N_{b}} }{n!} \cdot \prod_{i}^{n} \left[ c f_{s}(m_{i}|M_{H},\sigma)+ (1-c)f_{b}(m_{i}|\alpha)  \right] </div>
<script type="math/tex; mode=display">L_{s+b}(N_{s},N_{b},\alpha) = \dfrac{ N_{s}+N_{b}^{n} e^{N_{s}+N_{b}} }{n!} \cdot \prod_{i}^{n} \left[ c f_{s}(m_{i}|M_{H},\sigma)+ (1-c)f_{b}(m_{i}|\alpha)  \right] </script>
</div>
<p>where <span class="arithmatex"><span class="MathJax_Preview">c = \dfrac{ N_{s} }{ N_{s} + N_{b} }</span><script type="math/tex">c = \dfrac{ N_{s} }{ N_{s} + N_{b} }</script></span>,   <span class="arithmatex"><span class="MathJax_Preview">f_{s}(m|M_{H},\sigma)</span><script type="math/tex">f_{s}(m|M_{H},\sigma)</script></span> is the Gaussian signal pdf and <span class="arithmatex"><span class="MathJax_Preview">f_{b}(m|\alpha)</span><script type="math/tex">f_{b}(m|\alpha)</script></span> is the exponential pdf. Remember that <span class="arithmatex"><span class="MathJax_Preview">M_{H}</span><script type="math/tex">M_{H}</script></span> and <span class="arithmatex"><span class="MathJax_Preview">\sigma</span><script type="math/tex">\sigma</script></span> are fixed so that they are no longer parameters of the likelihood.</p>
<p>There is a simpler interface for maximum likelihood fits which is the <code>RooAbsPdf::fitTo</code> method. With this simple method, RooFit will construct the negative log-likelihood function, from the pdf, and minimize all of the free parameters in one step.</p>
<pre><code class="language-c++">model.fitTo(*hgg_data,RooFit::Extended());

model.plotOn(plot,RooFit::Components(&quot;exp&quot;),RooFit::LineColor(kGreen));
model.plotOn(plot,RooFit::LineColor(kRed));
model.paramOn(plot);

can-&gt;Clear();
plot-&gt;Draw();
can-&gt;Update();
can-&gt;Draw();
</code></pre>
<p><img alt="" src="../images/fit.png" /></p>
<p>What about if we also fit for the mass (<span class="arithmatex"><span class="MathJax_Preview">M_{H}</span><script type="math/tex">M_{H}</script></span>)? we can easily do this by removing the constant setting on MH.</p>
<pre><code class="language-c++">MH.setConstant(false);
model.fitTo(*hgg_data,RooFit::Extended());
</code></pre>
<details>
<summary><b>Show output</b></summary>

<pre><code class="language-shell">[#1] INFO:Minization -- RooMinimizer::optimizeConst: activating const optimization
[#1] INFO:Minization --  The following expressions will be evaluated in cache-and-track mode: (signal,exp)
 **********
 **    1 **SET PRINT           1
 **********
 **********
 **    2 **SET NOGRAD
 **********
 PARAMETER DEFINITIONS:
    NO.   NAME         VALUE      STEP SIZE      LIMITS
     1 MH           1.25000e+02  1.00000e+00    1.20000e+02  1.30000e+02
     2 alpha       -4.08793e-02  2.96856e-03   -2.00000e-01  1.00000e-02
     3 norm_b       9.67647e+02  3.25747e+01    0.00000e+00  1.00000e+03
 MINUIT WARNING IN PARAMETR
 ============== VARIABLE3 BROUGHT BACK INSIDE LIMITS.
     4 norm_s       3.22534e+01  1.16433e+01    1.00000e+01  1.00000e+02
 **********
 **    3 **SET ERR         0.5
 **********
 **********
 **    4 **SET PRINT           1
 **********
 **********
 **    5 **SET STR           1
 **********
 NOW USING STRATEGY  1: TRY TO BALANCE SPEED AGAINST RELIABILITY
 **********
 **    6 **MIGRAD        2000           1
 **********
 FIRST CALL TO USER FUNCTION AT NEW START POINT, WITH IFLAG=4.
 START MIGRAD MINIMIZATION.  STRATEGY  1.  CONVERGENCE WHEN EDM .LT. 1.00e-03
 FCN=-2327.53 FROM MIGRAD    STATUS=INITIATE       10 CALLS          11 TOTAL
                     EDM= unknown      STRATEGY= 1      NO ERROR MATRIX       
  EXT PARAMETER               CURRENT GUESS       STEP         FIRST   
  NO.   NAME      VALUE            ERROR          SIZE      DERIVATIVE 
   1  MH           1.25000e+02   1.00000e+00   2.01358e-01   1.12769e+01
   2  alpha       -4.08793e-02   2.96856e-03   3.30048e-02  -1.22651e-01
   3  norm_b       9.67647e+02   3.25747e+01   2.56674e-01  -1.96463e-02
   4  norm_s       3.22534e+01   1.16433e+01   3.10258e-01  -8.97036e-04
                               ERR DEF= 0.5
 MIGRAD MINIMIZATION HAS CONVERGED.
 MIGRAD WILL VERIFY CONVERGENCE AND ERROR MATRIX.
 COVARIANCE MATRIX CALCULATED SUCCESSFULLY
 FCN=-2327.96 FROM MIGRAD    STATUS=CONVERGED      65 CALLS          66 TOTAL
                     EDM=1.19174e-05    STRATEGY= 1      ERROR MATRIX ACCURATE 
  EXT PARAMETER                                   STEP         FIRST   
  NO.   NAME      VALUE            ERROR          SIZE      DERIVATIVE 
   1  MH           1.24628e+02   3.98153e-01   2.66539e-03   2.46327e-02
   2  alpha       -4.07708e-02   2.97195e-03   1.10093e-03   8.33780e-02
   3  norm_b       9.66105e+02   3.25772e+01   5.96627e-03   1.83523e-03
   4  norm_s       3.39026e+01   1.17380e+01   9.60816e-03  -2.32681e-03
                               ERR DEF= 0.5
 EXTERNAL ERROR MATRIX.    NDIM=  25    NPAR=  4    ERR DEF=0.5
  1.589e-01 -3.890e-05  1.462e-01 -1.477e-01 
 -3.890e-05  8.836e-06 -2.020e-04  2.038e-04 
  1.462e-01 -2.020e-04  1.073e+03 -1.072e+02 
 -1.477e-01  2.038e-04 -1.072e+02  1.420e+02 
 PARAMETER  CORRELATION COEFFICIENTS  
       NO.  GLOBAL      1      2      3      4
        1  0.04518   1.000 -0.033  0.011 -0.031
        2  0.03317  -0.033  1.000 -0.002  0.006
        3  0.27465   0.011 -0.002  1.000 -0.275
        4  0.27610  -0.031  0.006 -0.275  1.000
 **********
 **    7 **SET ERR         0.5
 **********
 **********
 **    8 **SET PRINT           1
 **********
 **********
 **    9 **HESSE        2000
 **********
 COVARIANCE MATRIX CALCULATED SUCCESSFULLY
 FCN=-2327.96 FROM HESSE     STATUS=OK             23 CALLS          89 TOTAL
                     EDM=1.19078e-05    STRATEGY= 1      ERROR MATRIX ACCURATE 
  EXT PARAMETER                                INTERNAL      INTERNAL  
  NO.   NAME      VALUE            ERROR       STEP SIZE       VALUE   
   1  MH           1.24628e+02   3.98106e-01   5.33077e-04  -7.45154e-02
   2  alpha       -4.07708e-02   2.97195e-03   2.20186e-04   5.42722e-01
   3  norm_b       9.66105e+02   3.26003e+01   2.38651e-04   1.20047e+00
   4  norm_s       3.39026e+01   1.17445e+01   3.84326e-04  -4.87967e-01
                               ERR DEF= 0.5
 EXTERNAL ERROR MATRIX.    NDIM=  25    NPAR=  4    ERR DEF=0.5
  1.588e-01 -3.888e-05  1.304e-01 -1.304e-01 
 -3.888e-05  8.836e-06 -1.954e-04  1.954e-04 
  1.304e-01 -1.954e-04  1.074e+03 -1.082e+02 
 -1.304e-01  1.954e-04 -1.082e+02  1.421e+02 
 PARAMETER  CORRELATION COEFFICIENTS  
       NO.  GLOBAL      1      2      3      4
        1  0.04274   1.000 -0.033  0.010 -0.027
        2  0.03314  -0.033  1.000 -0.002  0.006
        3  0.27694   0.010 -0.002  1.000 -0.277
        4  0.27806  -0.027  0.006 -0.277  1.000
[#1] INFO:Minization -- RooMinimizer::optimizeConst: deactivating const optimization
</code></pre>

</details>

<p>Notice the result for the fitted MH is not 125 and is included in the list of fitted parameters. 
We can get more information about the fit, via the <code>RooFitResult</code>, using the option <code>Save()</code>. </p>
<pre><code class="language-c++">RooFitResult *fit_res = (RooFitResult*) model.fitTo(*hgg_data,RooFit::Extended(),RooFit::Save());
</code></pre>
<p>For example, we can get the Correlation Matrix from the fit result... Note that the order of the parameters are the same as listed in the "Floating Parameter" list above</p>
<pre><code class="language-c++">TMatrixDSym cormat = fit_res-&gt;correlationMatrix();
cormat.Print();
</code></pre>
<pre><code class="language-shell">4x4 matrix is as follows

     |      0    |      1    |      2    |      3    |
---------------------------------------------------------
   0 |          1    -0.03282    0.009538    -0.02623 
   1 |   -0.03282           1   -0.001978    0.005439 
   2 |   0.009538   -0.001978           1     -0.2769 
   3 |   -0.02623    0.005439     -0.2769           1 
</code></pre>
<p>A nice feature of <code>RooFit</code> is that once we have a PDF, data and results like this, we can import this new model into our <code>RooWorkspace</code> and show off our new discovery to our LHC friends (if we weren't already too late!). We can also save the "state" of our parameters for later, by creating a snapshot of the current values. </p>
<pre><code class="language-c++">wspace-&gt;import(model);  
RooArgSet *params = model.getParameters(*hgg_data);
wspace-&gt;saveSnapshot(&quot;nominal_values&quot;,*params);

wspace-&gt;Print(&quot;V&quot;);
</code></pre>
<details>
<summary><b>Show output</b></summary>

<pre><code class="language-bash">RooWorkspace(workspace) Tutorial Workspace contents

variables
---------
(CMS_hgg_mass,MH,alpha,norm_b,norm_s,resolution)

p.d.f.s
-------
RooExponential::exp[ x=CMS_hgg_mass c=alpha ] = 0.00248636
RooAddPdf::model[ norm_s * signal + norm_b * exp ] = 0.00240205
RooGaussian::signal[ x=CMS_hgg_mass mean=MH sigma=resolution ] = 5.34013e-110

datasets
--------
RooDataSet::dataset(CMS_hgg_mass)

parameter snapshots
-------------------
nominal_values = (MH=124.627 +/- 0.398094,resolution=1[C],norm_s=33.9097 +/- 11.7445,alpha=-0.040779 +/- 0.00297195,norm_b=966.109 +/- 32.6025)
</code></pre>

 </details>

<p>This is exactly what needs to be done when you want to use shape based datacards in combine with parametric models.</p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
